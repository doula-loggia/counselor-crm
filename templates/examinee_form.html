{% extends "base.html" %}

{% block title %}{% if is_edit %}ìˆ˜ê²€ì ì •ë³´ ìˆ˜ì •{% else %}ìƒˆ ìˆ˜ê²€ì ë“±ë¡{% endif %} - ì‹¬ë¦¬ìƒë‹´ì‚¬ ë‚´ë‹´ì ê´€ë¦¬ ì‹œìŠ¤í…œ{% endblock %}

{% block content %}
<h2 style="margin-bottom: 1.5rem;">{% if is_edit %}ìˆ˜ê²€ì ì •ë³´ ìˆ˜ì •{% else %}ìƒˆ ìˆ˜ê²€ì ë“±ë¡{% endif %}</h2>

<div class="card">
    <form method="POST" action="{{ form_action }}" enctype="multipart/form-data" id="examineeForm">
        <div class="form-group">
            <label for="source">ìˆ˜ê²€ì ì¶œì²˜</label>
            <select id="source" name="source">
                {% for value, label in source_choices %}
                    <option value="{{ value }}" {% if examinee.source == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group" id="linkedClientContainer" style="display: none;">
            <label for="linked_client_id">ì—°ê²°í•  ë‚´ë‹´ì</label>
            <select id="linked_client_id" name="linked_client_id">
                <option value="">ë‚´ë‹´ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                {% for client in clients %}
                    <option value="{{ client.client_id }}" {% if examinee.linked_client_id == client.client_id or preselected_client_id == client.client_id %}selected{% endif %}>
                        {{ client.name }} ({{ client.client_id }})
                    </option>
                {% endfor %}
            </select>
            <small style="color: #7f8c8d; font-size: 0.85rem; margin-top: 0.3rem; display: block;">
                ê¸°ì¡´ ë‚´ë‹´ìë¥¼ ì„ íƒí•˜ë©´ ì¸ì  ì •ë³´ë¥¼ ë³„ë„ë¡œ ì…ë ¥í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
            </small>
        </div>
        
        <div id="personalInfoSection">
            <div class="form-group">
                <label for="name">ì´ë¦„ *</label>
                <input type="text" id="name" name="name" value="{{ examinee.name }}" required>
            </div>
            
            <div class="form-group">
                <label for="birth_year">ì¶œìƒì—°ë„</label>
                <input type="number" id="birth_year" name="birth_year" value="{{ examinee.birth_year }}" placeholder="1990" step="1">
            </div>
            
            <div class="form-group">
                <label for="gender">ì„±ë³„</label>
                <select id="gender" name="gender">
                    <option value="" {% if not examinee.gender %}selected{% endif %}>ì„ íƒì•ˆí•¨</option>
                    <option value="ë‚¨ì„±" {% if examinee.gender == 'ë‚¨ì„±' %}selected{% endif %}>ë‚¨ì„±</option>
                    <option value="ì—¬ì„±" {% if examinee.gender == 'ì—¬ì„±' %}selected{% endif %}>ì—¬ì„±</option>
                    <option value="ê¸°íƒ€" {% if examinee.gender == 'ê¸°íƒ€' %}selected{% endif %}>ê¸°íƒ€</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="phone">ì „í™”ë²ˆí˜¸</label>
                <input type="tel" id="phone" name="phone" value="{{ examinee.phone }}" placeholder="010-1234-5678">
            </div>
            
            <div class="form-group">
                <label for="email">ì´ë©”ì¼</label>
                <input type="email" id="email" name="email" value="{{ examinee.email }}">
            </div>
        </div>
        
        <div class="form-group">
            <label for="assessment_date">ê²€ì‚¬ ë‚ ì§œ</label>
            <input type="date" id="assessment_date" name="assessment_date" value="{{ examinee.assessment_date }}">
        </div>
        
        <div class="form-group">
            <label for="assessment_type">ê²€ì‚¬ ì¢…ë¥˜</label>
            <input type="text" id="assessment_type" name="assessment_type" value="{{ examinee.assessment_type }}" placeholder="ì˜ˆ: ì •ì„œê²€ì‚¬, ì„±ê²©ê²€ì‚¬">
        </div>
        
        <div class="form-group">
            <label for="assessment_tool">ì‚¬ìš© ê²€ì‚¬ ë„êµ¬</label>
            <input type="text" id="assessment_tool" name="assessment_tool" value="{{ examinee.assessment_tool }}" placeholder="ì˜ˆ: MMPI-2, BDI-II">
        </div>
        
        <div class="form-group">
            <label for="assessment_description">ê²€ì‚¬ ìš”ì•½ ë˜ëŠ” ë¹„ê³ </label>
            <textarea id="assessment_description" name="assessment_description" rows="4" placeholder="ê²€ì‚¬ ëª©ì , ì£¼ìš” ê²°ê³¼ ë“±ì„ ì…ë ¥í•˜ì„¸ìš”">{{ examinee.assessment_description }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="status">í˜„ì¬ ìƒíƒœ</label>
            <select id="status" name="status">
                {% for value, label in status_choices %}
                    <option value="{{ value }}" {% if examinee.status == value or (not examinee.status and value == 'evaluating') %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="notes">ìƒë‹´ì ë©”ëª¨</label>
            <textarea id="notes" name="notes" rows="4" placeholder="ê²€ì‚¬ ê´€ë ¨ ë©”ëª¨ë‚˜ í›„ì† ê³„íšì„ ì…ë ¥í•˜ì„¸ìš”">{{ examinee.notes }}</textarea>
        </div>
        
        <div class="form-group">
            <label for="report_file">ê²€ì‚¬ ë³´ê³ ì„œ íŒŒì¼</label>
            {% if examinee.report_file %}
                <p style="margin-bottom: 0.5rem; color: #3b5998;">
                    <a href="/download/examinee_report/{{ examinee.examinee_id }}" style="text-decoration: none;">
                        ğŸ“„ {{ examinee.report_file }} (ë‹¤ìš´ë¡œë“œ)
                    </a>
                </p>
            {% endif %}
            <input type="file" id="report_file" name="report_file" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png">
            <small style="color: #7f8c8d; font-size: 0.85rem; margin-top: 0.3rem; display: block;">PDF, DOC, DOCX, TXT, JPG, JPEG, PNG íŒŒì¼ ì—…ë¡œë“œ ê°€ëŠ¥</small>
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <button type="submit">{{ submit_label }}</button>
            {% if is_edit %}
                <a href="/examinees/{{ examinee.examinee_id }}" class="btn btn-secondary">ì·¨ì†Œ</a>
            {% else %}
                <a href="/examinees" class="btn btn-secondary">ì·¨ì†Œ</a>
            {% endif %}
        </div>
    </form>
</div>

<script>
const clientsData = {{ clients_json | tojson }};
const clientSelect = document.getElementById('linked_client_id');
const fields = {
    name: document.getElementById('name'),
    birth_year: document.getElementById('birth_year'),
    gender: document.getElementById('gender'),
    phone: document.getElementById('phone'),
    email: document.getElementById('email')
};
const isEditForm = {{ 'true' if is_edit else 'false' }};
const sourceSelect = document.getElementById('source');
const personalInfoSection = document.getElementById('personalInfoSection');
const linkedClientContainer = document.getElementById('linkedClientContainer');

function normalizeValue(value) {
    if (value === null || value === undefined) {
        return '';
    }
    const text = String(value);
    if (text.toLowerCase() === 'nan') {
        return '';
    }
    return text.endsWith('.0') ? text.slice(0, -2) : text;
}

function autoFillFromClient(force = false) {
    const selectedId = clientSelect.value;
    if (!selectedId) {
        return;
    }
    
    const client = clientsData.find(item => item.client_id === selectedId);
    if (!client) {
        return;
    }
    
    if (force || !fields.name.value) {
        fields.name.value = normalizeValue(client.name);
    }
    if (force || !fields.birth_year.value) {
        fields.birth_year.value = normalizeValue(client.birth_year);
    }
    if (force || !fields.gender.value) {
        fields.gender.value = normalizeValue(client.gender);
    }
    if (force || !fields.phone.value) {
        fields.phone.value = normalizeValue(client.phone);
    }
    if (force || !fields.email.value) {
        fields.email.value = normalizeValue(client.email);
    }
}

function updateVisibility() {
    const source = sourceSelect.value;
    const isExistingClient = source === 'existing_client';
    personalInfoSection.style.display = isExistingClient ? 'none' : 'block';
    linkedClientContainer.style.display = isExistingClient ? 'block' : 'none';
    Object.values(fields).forEach(field => {
        field.required = !isExistingClient && field.id === 'name';
    });
    if (!isExistingClient) {
        clientSelect.value = '';
    }
}

sourceSelect.addEventListener('change', () => {
    updateVisibility();
    if (sourceSelect.value !== 'existing_client') {
        Object.values(fields).forEach(field => {
            field.removeAttribute('readonly');
        });
    } else {
        autoFillFromClient(true);
    }
});

clientSelect.addEventListener('change', () => {
    autoFillFromClient(false);
});

const preselectedClientId = "{{ preselected_client_id }}";
const defaultSource = "{{ default_source }}";
if (defaultSource) {
    sourceSelect.value = defaultSource;
}
updateVisibility();

if (preselectedClientId) {
    clientSelect.value = preselectedClientId;
}

if ((preselectedClientId || sourceSelect.value === 'existing_client') && !isEditForm) {
    autoFillFromClient(true);
}
</script>
{% endblock %}
