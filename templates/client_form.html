{% extends "base.html" %}

{% block title %}새 내담자 추가 - 심리상담사 내담자 관리 시스템{% endblock %}

{% block content %}
<h2 style="margin-bottom: 1.5rem;">새 내담자 추가</h2>

<div class="card">
    <form method="POST" id="clientForm" enctype="multipart/form-data">
        <div class="form-group">
            <label for="name">이름 *</label>
            <input type="text" id="name" name="name" required>
        </div>
        
        <div class="form-group">
            <label for="birth_year">출생연도</label>
            <input type="number" id="birth_year" name="birth_year" placeholder="1990" step="1">
            <span id="age_display" style="color: #7f8c8d; font-size: 0.9rem; margin-top: 0.3rem; display: none;"></span>
            <span id="life_stage_display" style="color: #3498db; font-size: 0.9rem; margin-top: 0.3rem; display: none;"></span>
        </div>
        
        <div class="form-group">
            <label for="gender">성별</label>
            <select id="gender" name="gender">
                <option value="">선택안함</option>
                <option value="남성">남성</option>
                <option value="여성">여성</option>
                <option value="기타">기타</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="phone">전화번호</label>
            <input type="tel" id="phone" name="phone" placeholder="010-1234-5678">
        </div>
        
<div class="form-group">
    <label for="email">이메일</label>
    <input type="email" id="email" name="email">
</div>

<div class="form-group">
    <label for="referral_source">상담 유입 경로</label>
    <select id="referral_source" name="referral_source">
        <option value="">선택안함</option>
        {% for value, label in referral_source_choices %}
        <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
    </select>
</div>

<div class="form-group" id="referral_source_detail_group" style="display: none;">
    <label for="referral_source_detail">유입 경로 상세</label>
    <input type="text" id="referral_source_detail" name="referral_source_detail" placeholder="기타 유입 경로를 입력하세요">
</div>

<div class="form-group">
    <label for="first_session_date">첫 회기 날짜</label>
    <input type="date" id="first_session_date" name="first_session_date">
</div>
        
        <div class="form-group">
            <label for="tagInput">태그 (쉼표로 구분)</label>
            <div id="tagsContainer" style="border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; min-height: 50px; display: flex; flex-wrap: wrap; gap: 0.3rem; align-items: center; background: white;">
                <input type="text" id="tagInput" style="border: none; outline: none; flex: 1; min-width: 150px; padding: 0.3rem;" placeholder="태그 입력 후 쉼표 또는 엔터">
            </div>
            <input type="hidden" id="tags" name="tags">
            <div id="tagSuggestions" style="position: relative; margin-top: 0.3rem;">
                <div id="suggestionsList" style="display: none; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; position: absolute; width: 100%; z-index: 1000;"></div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="medical_history">과거병력</label>
            <textarea id="medical_history" name="medical_history" placeholder="과거 병력이나 현재 약물 복용 등을 입력하세요" rows="3"></textarea>
        </div>
        
        <div class="form-group">
            <label for="counseling_history">상담이력</label>
            <textarea id="counseling_history" name="counseling_history" placeholder="과거 상담 경험 및 치료 이력을 입력하세요" rows="3"></textarea>
        </div>
        
        <div class="form-group">
            <label for="psychTestInput">심리검사 명칭 (쉼표로 구분)</label>
            <div id="psychTestContainer" style="border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; min-height: 50px; display: flex; flex-wrap: wrap; gap: 0.3rem; align-items: center; background: white;">
                <input type="text" id="psychTestInput" style="border: none; outline: none; flex: 1; min-width: 150px; padding: 0.3rem;" placeholder="심리검사 명칭 입력 후 쉼표 또는 엔터">
            </div>
            <input type="hidden" id="psychological_test_names" name="psychological_test_names">
            <small style="color: #7f8c8d; font-size: 0.85rem; margin-top: 0.3rem; display: block;">심리검사 명칭을 입력한 뒤 쉼표(,) 또는 엔터로 추가하세요.</small>
        </div>
        
        <div class="form-group">
            <label for="psychological_test">심리검사 결과 파일</label>
            <input type="file" id="psychological_test" name="psychological_test" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png">
            <small style="color: #7f8c8d; font-size: 0.85rem; margin-top: 0.3rem; display: block;">PDF, DOC, DOCX, TXT, JPG, JPEG, PNG 파일 업로드 가능</small>
        </div>
        
        <div class="form-group">
            <label for="notes">상담자 메모</label>
            <textarea id="notes" name="notes" placeholder="추가 정보나 메모를 입력하세요"></textarea>
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <button type="submit">저장</button>
            <a href="/clients" class="btn btn-secondary">취소</a>
        </div>
    </form>
</div>

<script>
const existingTags = {{ existing_tags|tojson }};
let selectedTags = [];
const clientForm = document.getElementById('clientForm');

const tagInput = document.getElementById('tagInput');
const tagsContainer = document.getElementById('tagsContainer');
const tagsHiddenInput = document.getElementById('tags');
const suggestionsList = document.getElementById('suggestionsList');

function addTag(tagText) {
    const trimmedTag = tagText.trim();
    if (!trimmedTag || selectedTags.includes(trimmedTag)) return;
    
    selectedTags.push(trimmedTag);
    renderTags();
    updateHiddenInput();
    tagInput.value = '';
    suggestionsList.style.display = 'none';
}

function removeTag(tagText) {
    selectedTags = selectedTags.filter(t => t !== tagText);
    renderTags();
    updateHiddenInput();
}

function renderTags() {
    const existingTagElements = tagsContainer.querySelectorAll('.tag-item');
    existingTagElements.forEach(el => el.remove());
    
    selectedTags.forEach(tag => {
        const tagEl = document.createElement('span');
        tagEl.className = 'tag-item';
        tagEl.style.cssText = 'background: #3498db; color: white; padding: 0.3rem 0.6rem; border-radius: 3px; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.3rem;';
        tagEl.innerHTML = `${tag} <span style="cursor: pointer; font-weight: bold;" onclick="removeTag('${tag}')">&times;</span>`;
        tagsContainer.insertBefore(tagEl, tagInput);
    });
}

function updateHiddenInput() {
    tagsHiddenInput.value = selectedTags.join(', ');
}

function showSuggestions(inputValue) {
    const filtered = existingTags.filter(tag => 
        tag.toLowerCase().includes(inputValue.toLowerCase()) && 
        !selectedTags.includes(tag)
    );
    
    if (filtered.length === 0 || !inputValue) {
        suggestionsList.style.display = 'none';
        return;
    }
    
    suggestionsList.innerHTML = filtered.map(tag => 
        `<div style="padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #eee;" 
              onmouseover="this.style.background='#ecf0f1'" 
              onmouseout="this.style.background='white'"
              onclick="addTag('${tag}')">${tag}</div>`
    ).join('');
    suggestionsList.style.display = 'block';
}

tagInput.addEventListener('input', (e) => {
    showSuggestions(e.target.value);
});

tagInput.addEventListener('keydown', (e) => {
    if (e.key === ',' || e.key === 'Enter') {
        e.preventDefault();
        const value = tagInput.value.replace(',', '').trim();
        if (value) {
            addTag(value);
        }
    }
});

tagInput.addEventListener('blur', () => {
    setTimeout(() => {
        suggestionsList.style.display = 'none';
    }, 200);
});

const birthYearInput = document.getElementById('birth_year');
const ageDisplay = document.getElementById('age_display');
const lifeStageDisplay = document.getElementById('life_stage_display');

function computeLifeStage(birthYear) {
    const currentYear = new Date().getFullYear();
    const age = currentYear - birthYear;
    if (age <= 6) return '유아';
    if (age <= 12) return '아동';
    if (age <= 18) return '청소년';
    return '성인';
}

birthYearInput.addEventListener('input', (e) => {
    const birthYear = parseInt(e.target.value);
    
    if (!birthYear || birthYear < 1900 || birthYear > new Date().getFullYear()) {
        ageDisplay.style.display = 'none';
        lifeStageDisplay.style.display = 'none';
        return;
    }
    
    const currentYear = new Date().getFullYear();
    const age = currentYear - birthYear;
    
    ageDisplay.textContent = `만 ${age}세`;
    ageDisplay.style.display = 'block';
    lifeStageDisplay.textContent = `연령대: ${computeLifeStage(birthYear)}`;
    lifeStageDisplay.style.display = 'block';
});

const psychTestContainer = document.getElementById('psychTestContainer');
const psychTestInput = document.getElementById('psychTestInput');
const psychTestHiddenInput = document.getElementById('psychological_test_names');
let psychTestNames = [];

function refreshPsychTestNames() {
    psychTestHiddenInput.value = psychTestNames.join(', ');
    
    const existingTagElements = psychTestContainer.querySelectorAll('.psych-test-tag');
    existingTagElements.forEach(el => el.remove());
    
    psychTestNames.forEach(name => {
        const tagEl = document.createElement('span');
        tagEl.className = 'psych-test-tag';
        tagEl.style.cssText = 'background: #8e44ad; color: white; padding: 0.3rem 0.6rem; border-radius: 3px; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.3rem;';
        
        const textSpan = document.createElement('span');
        textSpan.textContent = name;
        
        const removeBtn = document.createElement('span');
        removeBtn.textContent = '×';
        removeBtn.style.cursor = 'pointer';
        removeBtn.style.fontWeight = 'bold';
        removeBtn.addEventListener('click', () => {
            psychTestNames = psychTestNames.filter(item => item !== name);
            refreshPsychTestNames();
        });
        
        tagEl.appendChild(textSpan);
        tagEl.appendChild(removeBtn);
        psychTestContainer.insertBefore(tagEl, psychTestInput);
    });
}

function addPsychTestNamesFromInput(rawValue) {
    if (!rawValue) return;
    
    const names = rawValue.split(',').map(name => name.trim()).filter(name => name);
    let updated = false;
    
    names.forEach(name => {
        if (!psychTestNames.includes(name)) {
            psychTestNames.push(name);
            updated = true;
        }
    });
    
    if (updated) {
        refreshPsychTestNames();
    }
    
    psychTestInput.value = '';
}

psychTestInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ',') {
        e.preventDefault();
        addPsychTestNamesFromInput(psychTestInput.value);
    }
});

psychTestInput.addEventListener('blur', () => {
    addPsychTestNamesFromInput(psychTestInput.value);
});

function toggleReferralDetail(value) {
    const group = document.getElementById('referral_source_detail_group');
    if (!group) return;
    if (value === 'other') {
        group.style.display = 'block';
    } else {
        group.style.display = 'none';
        const detailInput = document.getElementById('referral_source_detail');
        if (detailInput) {
            detailInput.value = '';
        }
    }
}

const referralSourceSelect = document.getElementById('referral_source');
if (referralSourceSelect) {
    toggleReferralDetail(referralSourceSelect.value);
    referralSourceSelect.addEventListener('change', (event) => {
        toggleReferralDetail(event.target.value);
    });
}

clientForm.addEventListener('submit', () => {
    const currentTagInput = tagInput.value.trim();
    if (currentTagInput) {
        addTag(currentTagInput);
    }
    
    if (psychTestInput.value.trim()) {
        addPsychTestNamesFromInput(psychTestInput.value);
    }
});

refreshPsychTestNames();
</script>

{% endblock %}
