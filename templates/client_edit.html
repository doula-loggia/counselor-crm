{% extends "base.html" %}

{% block title %}내담자 정보 수정 - 치료사 클라이언트 관리 시스템{% endblock %}

{% block content %}
<h2 style="margin-bottom: 1.5rem;">내담자 정보 수정</h2>

<div class="card">
    <form method="POST">
        <div class="form-group">
            <label for="name">이름 *</label>
            <input type="text" id="name" name="name" value="{{ client.name }}" required>
        </div>
        
        <div class="form-group">
            <label for="phone">전화번호</label>
            <input type="tel" id="phone" name="phone" value="{{ client.phone }}" placeholder="010-1234-5678">
        </div>
        
        <div class="form-group">
            <label for="email">이메일</label>
            <input type="email" id="email" name="email" value="{{ client.email }}">
        </div>
        
        <div class="form-group">
            <label for="birth_year">출생연도</label>
            <input type="number" id="birth_year" name="birth_year" value="{% if client.birth_year %}{{ client.birth_year | int }}{% endif %}" placeholder="1990" step="1">
            <span id="age_display" style="color: #7f8c8d; font-size: 0.9rem; margin-top: 0.3rem; display: none;"></span>
        </div>
        
        <div class="form-group">
            <label for="gender">성별</label>
            <select id="gender" name="gender">
                <option value="" {% if not client.gender %}selected{% endif %}>선택안함</option>
                <option value="남성" {% if client.gender == '남성' %}selected{% endif %}>남성</option>
                <option value="여성" {% if client.gender == '여성' %}selected{% endif %}>여성</option>
                <option value="기타" {% if client.gender == '기타' %}selected{% endif %}>기타</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="first_session_date">첫 회기 날짜</label>
            <input type="date" id="first_session_date" name="first_session_date" value="{{ client.first_session_date }}">
        </div>
        
        <div class="form-group">
            <label for="status">상태</label>
            <select id="status" name="status">
                <option value="active" {% if client.status == 'active' %}selected{% endif %}>활성</option>
                <option value="inactive" {% if client.status == 'inactive' %}selected{% endif %}>비활성</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="tagInput">태그 (쉼표로 구분)</label>
            <div id="tagsContainer" style="border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; min-height: 50px; display: flex; flex-wrap: wrap; gap: 0.3rem; align-items: center; background: white;">
                <input type="text" id="tagInput" style="border: none; outline: none; flex: 1; min-width: 150px; padding: 0.3rem;" placeholder="태그 입력 후 쉼표 또는 엔터">
            </div>
            <input type="hidden" id="tags" name="tags" value="{{ client.tags }}">
            <div id="tagSuggestions" style="position: relative; margin-top: 0.3rem;">
                <div id="suggestionsList" style="display: none; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; position: absolute; width: 100%; z-index: 1000;"></div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="notes">메모</label>
            <textarea id="notes" name="notes" placeholder="추가 정보나 메모를 입력하세요">{{ client.notes }}</textarea>
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <button type="submit">저장</button>
            <a href="/clients" class="btn btn-secondary">취소</a>
        </div>
    </form>
</div>

<script>
const existingTags = {{ existing_tags|tojson }};
const initialTags = "{{ client.tags }}";
let selectedTags = [];

const tagInput = document.getElementById('tagInput');
const tagsContainer = document.getElementById('tagsContainer');
const tagsHiddenInput = document.getElementById('tags');
const suggestionsList = document.getElementById('suggestionsList');

if (initialTags) {
    selectedTags = initialTags.split(',').map(t => t.trim()).filter(t => t);
    renderTags();
}

function addTag(tagText) {
    const trimmedTag = tagText.trim();
    if (!trimmedTag || selectedTags.includes(trimmedTag)) return;
    
    selectedTags.push(trimmedTag);
    renderTags();
    updateHiddenInput();
    tagInput.value = '';
    suggestionsList.style.display = 'none';
}

function removeTag(tagText) {
    selectedTags = selectedTags.filter(t => t !== tagText);
    renderTags();
    updateHiddenInput();
}

function renderTags() {
    const existingTagElements = tagsContainer.querySelectorAll('.tag-item');
    existingTagElements.forEach(el => el.remove());
    
    selectedTags.forEach(tag => {
        const tagEl = document.createElement('span');
        tagEl.className = 'tag-item';
        tagEl.style.cssText = 'background: #3498db; color: white; padding: 0.3rem 0.6rem; border-radius: 3px; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.3rem;';
        tagEl.innerHTML = `${tag} <span style="cursor: pointer; font-weight: bold;" onclick="removeTag('${tag}')">&times;</span>`;
        tagsContainer.insertBefore(tagEl, tagInput);
    });
}

function updateHiddenInput() {
    tagsHiddenInput.value = selectedTags.join(', ');
}

function showSuggestions(inputValue) {
    const filtered = existingTags.filter(tag => 
        tag.toLowerCase().includes(inputValue.toLowerCase()) && 
        !selectedTags.includes(tag)
    );
    
    if (filtered.length === 0 || !inputValue) {
        suggestionsList.style.display = 'none';
        return;
    }
    
    suggestionsList.innerHTML = filtered.map(tag => 
        `<div style="padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #eee;" 
              onmouseover="this.style.background='#ecf0f1'" 
              onmouseout="this.style.background='white'"
              onclick="addTag('${tag}')">${tag}</div>`
    ).join('');
    suggestionsList.style.display = 'block';
}

tagInput.addEventListener('input', (e) => {
    showSuggestions(e.target.value);
});

tagInput.addEventListener('keydown', (e) => {
    if (e.key === ',' || e.key === 'Enter') {
        e.preventDefault();
        const value = tagInput.value.replace(',', '').trim();
        if (value) {
            addTag(value);
        }
    }
});

tagInput.addEventListener('blur', () => {
    setTimeout(() => {
        suggestionsList.style.display = 'none';
    }, 200);
});

document.querySelector('form').addEventListener('submit', (e) => {
    const currentInput = tagInput.value.trim();
    if (currentInput) {
        addTag(currentInput);
    }
});

const birthYearInput = document.getElementById('birth_year');
const ageDisplay = document.getElementById('age_display');

function updateAge() {
    const birthYear = parseInt(birthYearInput.value);
    
    if (!birthYear || birthYear < 1900 || birthYear > new Date().getFullYear()) {
        ageDisplay.style.display = 'none';
        return;
    }
    
    const currentYear = new Date().getFullYear();
    const age = currentYear - birthYear;
    
    ageDisplay.textContent = `만 ${age}세`;
    ageDisplay.style.display = 'block';
}

if (birthYearInput.value) {
    updateAge();
}

birthYearInput.addEventListener('input', updateAge);
</script>

{% endblock %}
