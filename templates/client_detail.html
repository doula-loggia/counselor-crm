{% extends "base.html" %}

{% block title %}{{ client.name }} - ë‚´ë‹´ì ìƒì„¸{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h2>{{ client.name }} ë‹˜</h2>
    <div style="display: flex; gap: 0.5rem;">
        <a href="/clients/{{ client.client_id }}/edit" class="btn">ì •ë³´ ìˆ˜ì •</a>
        <a href="/clients" class="btn btn-secondary">ëª©ë¡ìœ¼ë¡œ</a>
    </div>
</div>

<div class="card" style="margin-bottom: 1.5rem;">
    <h3 style="margin-bottom: 1rem;">ê¸°ë³¸ ì •ë³´</h3>
    <table style="margin: 0;">
        <tr>
            <th style="width: 20%;">ì´ë¦„</th>
            <td><strong>{{ client.name }}</strong></td>
        </tr>
        <tr>
            <th>ì „í™”ë²ˆí˜¸</th>
            <td>{{ client.phone }}</td>
        </tr>
        <tr>
            <th>ì´ë©”ì¼</th>
            <td>{{ client.email }}</td>
        </tr>
        <tr>
            <th>ì¶œìƒì—°ë„</th>
            <td>
                {% if client.birth_year %}
                    {{ client.birth_year | int }}
                    <span id="age_display" style="color: #7f8c8d; margin-left: 0.5rem;"></span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>ì—°ë ¹ëŒ€</th>
            <td>
                {% set life_stage_labels = {'infant': 'ìœ ì•„', 'child': 'ì•„ë™', 'youth': 'ì²­ì†Œë…„', 'adult': 'ì„±ì¸'} %}
                {{ life_stage_labels.get(client.life_stage, 'ë¯¸ì§€ì •') }}
            </td>
        </tr>
        <tr>
            <th>ì„±ë³„</th>
            <td>{{ client.gender }}</td>
        </tr>
        <tr>
            <th>ì²« íšŒê¸° ë‚ ì§œ</th>
            <td>{{ client.first_session_date }}</td>
        </tr>
        <tr>
            <th>ìƒíƒœ</th>
            <td>
                {% if client.status == 'counseling' %}
                    <span style="color: #27ae60; font-weight: bold;">ìƒë‹´ì¤‘</span>
                {% elif client.status == 'reengaged' %}
                    <span style="color: #1d4ed8; font-weight: bold;">ì¬ìƒë‹´</span>
                {% else %}
                    <span style="color: #95a5a6;">ì¢…ê²°</span>
                {% endif %}
            </td>
        </tr>
        {% if client.reengaged_at %}
        <tr>
            <th>ì¬ìƒë‹´ ì‹œì‘ì¼</th>
            <td>{{ client.reengaged_at }}</td>
        </tr>
        {% endif %}
        <tr>
            <th>ìƒë‹´ ìœ ì… ê²½ë¡œ</th>
            <td>
                {% set source_label = referral_source_labels.get(client.referral_source) %}
                {% if source_label %}
                    {{ source_label }}
                    {% if client.referral_source_detail %}
                        <span style="color: #6b7280; margin-left: 0.5rem;">{{ client.referral_source_detail }}</span>
                    {% endif %}
                {% elif client.referral_source_detail %}
                    {{ client.referral_source_detail }}
                {% else %}
                    -
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>íƒœê·¸</th>
            <td>{{ client.tags }}</td>
        </tr>
        {% if client.medical_history %}
        <tr>
            <th>ê³¼ê±°ë³‘ë ¥</th>
            <td style="white-space: pre-wrap;">{{ client.medical_history }}</td>
        </tr>
        {% endif %}
        {% if client.counseling_history %}
        <tr>
            <th>ìƒë‹´ì´ë ¥</th>
            <td style="white-space: pre-wrap;">{{ client.counseling_history }}</td>
        </tr>
        {% endif %}
        {% set psych_test_names = client.psychological_test_names.split(',') if client.psychological_test_names else [] %}
        {% if psych_test_names %}
        <tr>
            <th>ì‹¬ë¦¬ê²€ì‚¬ ëª…ì¹­</th>
            <td>
                {% for raw_name in psych_test_names %}
                    {% set trimmed_name = raw_name.strip() %}
                    {% if trimmed_name %}
                        <span style="background: #8e44ad; color: white; padding: 0.3rem 0.6rem; border-radius: 3px; font-size: 0.9rem; display: inline-block; margin-right: 0.3rem; margin-bottom: 0.3rem;">{{ trimmed_name }}</span>
                    {% endif %}
                {% endfor %}
            </td>
        </tr>
        {% endif %}
        {% if client.psychological_test_file %}
        <tr>
            <th>ì‹¬ë¦¬ê²€ì‚¬ íŒŒì¼</th>
            <td>
                <a href="/download/psychological_test/{{ client.client_id }}" style="color: #3498db; text-decoration: none;">
                    ğŸ“„ {{ client.psychological_test_file }} (ë‹¤ìš´ë¡œë“œ)
                </a>
            </td>
        </tr>
        {% endif %}
{% if client.notes %}
        <tr>
            <th>ìƒë‹´ì ë©”ëª¨</th>
            <td style="white-space: pre-wrap;">{{ client.notes }}</td>
        </tr>
        {% endif %}
    </table>
</div>

<div class="card" style="margin-bottom: 1.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
        <h3>ë™ì˜ì„œ ê´€ë¦¬ ({{ consents|length }}ê±´)</h3>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <a href="/clients/{{ client.client_id }}/consents/bootstrap" class="btn btn-secondary">í•„ìˆ˜ ë™ì˜ì„œ ìë™ìƒì„±</a>
            <a href="/clients/{{ client.client_id }}/consents/new" class="btn">ë™ì˜ì„œ ê¸°ë¡</a>
        </div>
    </div>
    {% if consents %}
    <table>
        <thead>
            <tr>
                <th>ë™ì˜ì„œ</th>
                <th>ìƒíƒœ</th>
                <th>ì„œëª…ì¼</th>
                <th>ë§Œë£Œì¼</th>
                <th>ì²¨ë¶€</th>
                <th>ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody>
            {% for consent in consents %}
            <tr>
                <td>{{ consent_types.get(consent.consent_type, consent.consent_type) }}</td>
                <td>
                    {% set status_label = consent_statuses.get(consent.status, consent.status) %}
                    {% if consent.status == 'signed' %}
                        <span style="color: #27ae60; font-weight: 600;">{{ status_label }}</span>
                    {% elif consent.status == 'pending' %}
                        <span style="color: #f39c12; font-weight: 600;">{{ status_label }}</span>
                    {% else %}
                        <span style="color: #e74c3c; font-weight: 600;">{{ status_label }}</span>
                    {% endif %}
                </td>
                <td>{{ consent.signed_at or '-' }}</td>
                <td>{{ consent.expires_at or '-' }}</td>
                <td>
                    {% if consent.file_path %}
                        <a href="/download/consent/{{ consent.consent_id }}" style="color: #3b5998;">íŒŒì¼</a>
                    {% else %}
                        <span style="color: #95a5a6;">ì—†ìŒ</span>
                    {% endif %}
                </td>
                <td>
                    <a href="/clients/{{ client.client_id }}/consents/{{ consent.consent_id }}/edit" style="color: #27ae60; margin-right: 0.5rem;">ìˆ˜ì •</a>
                    <form method="POST" action="/clients/{{ client.client_id }}/consents/{{ consent.consent_id }}/delete" style="display: inline;" onsubmit="return confirm('ë™ì˜ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        <button type="submit" style="background: none; border: none; color: #e74c3c; cursor: pointer; padding: 0;">ì‚­ì œ</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: #7f8c8d; padding: 1.5rem;">ë“±ë¡ëœ ë™ì˜ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
</div>

<div class="card" style="margin-bottom: 1.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
        <h3>ì‹¬ë¦¬ê²€ì‚¬ ê¸°ë¡ ({{ examinees|length }}ê±´)</h3>
        <div style="position: relative;">
            <button type="button" id="examineeActionsBtn" class="btn" style="display: inline-flex; align-items: center; gap: 0.3rem;">
                ê²€ì‚¬ ê¸°ë¡ ì¶”ê°€ â–¾
            </button>
            <div id="examineeActionsMenu" style="display: none; position: absolute; right: 0; top: calc(100% + 0.3rem); background: #ffffff; border: 1px solid #d1d5db; border-radius: 6px; box-shadow: 0 8px 16px rgba(15, 23, 42, 0.15); min-width: 180px; z-index: 2000;">
                <a href="/examinees/new?client_id={{ client.client_id }}" style="display: block; padding: 0.7rem 1rem; color: #1f2937; text-decoration: none; border-bottom: 1px solid #e5e7eb;">
                    ìƒˆ ìˆ˜ê²€ì ë“±ë¡
                    <div style="font-size: 0.8rem; color: #6b7280; margin-top: 0.2rem;">ë‚´ë‹´ì ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹ ê·œ ê²€ì‚¬ ë“±ë¡</div>
                </a>
                <a href="/examinees/new?client_id={{ client.client_id }}&purpose=followup" style="display: block; padding: 0.7rem 1rem; color: #1f2937; text-decoration: none;">
                    ì¶”ê°€ ê²€ì‚¬ ê¸°ë¡
                    <div style="font-size: 0.8rem; color: #6b7280; margin-top: 0.2rem;">ì¶”ê°€Â·ì¶”ì  ê²€ì‚¬ë¥¼ ê¸°ë¡í•  ë•Œ ì‚¬ìš©</div>
                </a>
            </div>
        </div>
    </div>
    {% if examinees %}
    <table>
        <thead>
            <tr>
                <th>ê²€ì‚¬ì¼</th>
                <th>ê²€ì‚¬ ì¢…ë¥˜</th>
                <th>ë„êµ¬</th>
                <th>ìƒíƒœ</th>
                <th>ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody>
            {% for examinee in examinees %}
            <tr>
                <td>{{ examinee.assessment_date or '-' }}</td>
                <td>{{ examinee.assessment_type or '-' }}</td>
                <td>{{ examinee.assessment_tool or '-' }}</td>
                <td>{{ examinee_status_labels.get(examinee.status, examinee.status or '-') }}</td>
                <td>
                    <a href="/examinees/{{ examinee.examinee_id }}" style="color: #3b5998; text-decoration: none;">ìƒì„¸</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: #7f8c8d; padding: 1.5rem;">ë“±ë¡ëœ ì‹¬ë¦¬ê²€ì‚¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>íšŒê¸° ê¸°ë¡ ({{ sessions|length }}íšŒ)</h3>
        <a href="/sessions/new" class="btn">ìƒˆ íšŒê¸° ì¶”ê°€</a>
    </div>
    
    {% if sessions %}
    <table>
        <thead>
            <tr>
                <th>ë‚ ì§œ</th>
                <th>ìƒë‹´ í˜•íƒœ</th>
                <th>ì°¸ì—¬ì</th>
                <th>ëª¨ë“œ</th>
                <th>ëª©í‘œ</th>
                <th>ë¹„ìš©</th>
                <th>ë‚©ë¶€</th>
                <th>ê²°ì œìˆ˜ë‹¨</th>
                <th>í‰ê°€</th>
                <th>ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody>
            {% for session in sessions %}
            <tr>
                <td>
                    <a href="/sessions/{{ session.session_id }}" style="color: #3b5998; text-decoration: none; font-weight: 600; display: block; transition: color 0.2s;" 
                       onmouseover="this.style.color='#2d4373'" 
                       onmouseout="this.style.color='#3b5998'">
                        {{ session.date }}
                    </a>
                </td>
                <td>{{ 'ì§‘ë‹¨' if session.counseling_type == 'group' else 'ê°œë³„' }}</td>
                <td>{{ session.participant_display }}</td>
                <td>{{ session.mode }}</td>
                <td>{{ session.goals[:50] }}{% if session.goals|length > 50 %}...{% endif %}</td>
                <td>{% if session.fee %}{{ (session.fee | float / 10000) | int }}ë§Œì›{% endif %}</td>
                <td>
                    {% if session.paid == 'Y' %}
                        <span style="color: #27ae60;">âœ“</span>
                    {% else %}
                        <span style="color: #e74c3c;">âœ—</span>
                    {% endif %}
                </td>
                <td>{{ session.payment_method }}</td>
                <td>
                    {% if session.rating %}
                        {{ session.rating }}/5
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <a href="/sessions/{{ session.session_id }}/edit" style="color: #27ae60; text-decoration: none; font-weight: 500;">ìˆ˜ì •</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: #7f8c8d; padding: 2rem;">
        ì•„ì§ ë“±ë¡ëœ íšŒê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.
    </p>
    {% endif %}
</div>

<script>
const examineeActionsBtn = document.getElementById('examineeActionsBtn');
const examineeActionsMenu = document.getElementById('examineeActionsMenu');

function closeExamineeMenu() {
    if (examineeActionsMenu) {
        examineeActionsMenu.style.display = 'none';
    }
}

if (examineeActionsBtn && examineeActionsMenu) {
    examineeActionsBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        const isOpen = examineeActionsMenu.style.display === 'block';
        examineeActionsMenu.style.display = isOpen ? 'none' : 'block';
    });
    
    document.addEventListener('click', (event) => {
        if (!examineeActionsMenu.contains(event.target) && event.target !== examineeActionsBtn) {
            closeExamineeMenu();
        }
    });
    
    window.addEventListener('blur', closeExamineeMenu);
}

const birthYear = {{ client.birth_year | int if client.birth_year else 0 }};
const ageDisplay = document.getElementById('age_display');

if (birthYear > 0) {
    const currentYear = new Date().getFullYear();
    const age = currentYear - birthYear;
    ageDisplay.textContent = `(ë§Œ ${age}ì„¸)`;
}
</script>

{% endblock %}
